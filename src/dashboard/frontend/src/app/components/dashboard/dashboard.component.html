<!-- components/dashboard/dashboard.component.html -->
<div class="dashboard-container">
  <!-- Header -->
  <header>
    <div class="header-left">
      <h1>Dashboard</h1>
      @if (userTenant()) {
        <span class="tenant-badge">{{ tenantName() }}</span>
      }
    </div>
    <div class="header-right">
      <span class="user-info">{{ userName() }}</span>
      <button (click)="logout()" class="logout-btn">Logout</button>
    </div>
  </header>

  <main>
    @if (currentUser(); as user) {
      <!-- Account Info Section -->
      <section class="section">
        <h2>Informazioni account</h2>
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Username</span>
            <span class="info-value">{{ user.username }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Tenant</span>
            <span class="info-value">{{ user.tenant.name }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Tenant ID</span>
            <span class="info-value">{{ user.tenant.natsId }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Creato</span>
            <span class="info-value">{{ user.createdAt | date:'mediumDate' }}</span>
          </div>
        </div>
      </section>

      <!-- Chart Panel -->
      @if (selectedSensor(); as sensor) {
        <section class="section">
          <div class="section-header">
            <h2>
              @if (isLiveMode()) {
                Dati real-time
              } @else {
                Dati storici
              }
            </h2>
            <button (click)="closePanel()" class="close-btn">Chiudi</button>
          </div>

          <div class="chart-panel" [class.live]="isLiveMode()" [class.history]="!isLiveMode()">
            <!-- Panel Header -->
            <div class="panel-header">
              <div class="panel-info">
                <span class="panel-sensor-name">{{ sensor.name }}</span>
                @if (isLiveMode() && latestReading(); as reading) {
                  <span class="current-value"> {{ reading.value }} {{ sensor.unit }}</span>
                }
              </div>
              
              @if (isLiveMode()) {
                <span class="status-badge" [class.connected]="wsConnected()">
                  {{ wsConnected() ? 'Connesso' : 'Connessione...' }}
                </span>
              } @else {
                <span class="history-badge">Ultimi 60 minuti</span>
              }
            </div>

            <!-- Chart Content -->
            <div class="panel-content">
              <!-- Live Mode -->
              @if (isLiveMode()) {
                @if (wsError()) {
                  <div class="panel-error">{{ wsError() }}</div>
                } @else if (liveReadings().length > 0) {
                  <app-sensor-chart
                    [sensor]="sensor"
                    [readings]="liveReadings()"
                  />
                  <div class="panel-footer">
                    <span>Gateway: {{ latestReading()?.gateway }}</span>
                    <span> {{ liveReadings().length }} letture</span>
                  </div>
                } @else {
                  <div class="panel-waiting">
                    <span class="spinner-small"></span>
                    In attesa di dati...
                  </div>
                }
              }

              <!-- History Mode -->
              @if (!isLiveMode()) {
                @if (historicLoading()) {
                  <div class="panel-waiting">
                    <span class="spinner-small"></span>
                    Caricamento dati...
                  </div>
                } @else if (historicError()) {
                  <div class="panel-error">{{ historicError() }}</div>
                } @else if (historicReadings().length === 0) {
                  <div class="panel-empty">Nessun dato disponibile.</div>
                } @else {
                  <app-sensor-chart
                    [sensor]="sensor"
                    [readings]="historicReadings()"
                  />
                  <div class="panel-footer">
                    <span>{{ historicReadings().length }} letture</span>
                    <span>
                      {{ historicReadings()[0]?.timestamp | date:'short' }} - 
                      {{ historicReadings()[historicReadings().length - 1]?.timestamp | date:'short' }}
                    </span>
                  </div>
                }
              }
            </div>
          </div>
        </section>
      }

      <!-- Sensors Section -->
      <section class="section">
        <h2>Sensori</h2>
        <div class="table-container">
          <table class="sensors-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipologia</th>
                <th>Unit√† di misura</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              @for (sensor of sensorList; track sensor.id) {
                <tr [class.selected]="isSensorSelected(sensor)">
                  <td class="sensor-name">{{ sensor.name }}</td>
                  <td>{{ sensor.sensorType }}</td>
                  <td>{{ sensor.unit }}</td>
                  <td class="actions-cell">
                    <button 
                      class="action-btn live-btn"
                      [class.active]="isSensorSelected(sensor) && isLiveMode()"
                      (click)="onLiveClick(sensor, $event)"
                    >
                      Dati real-time
                    </button>
                    <button 
                      class="action-btn history-btn"
                      [class.active]="isSensorSelected(sensor) && !isLiveMode()"
                      (click)="onHistoryClick(sensor, $event)"
                    >
                      Dati storici
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>

    } @else {
      <div class="loading-state">
        <span class="spinner"></span>
        <p>Loading dashboard...</p>
      </div>
    }
  </main>
</div>